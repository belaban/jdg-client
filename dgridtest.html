<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>JDG client</title>
    <!-- this cofiguration assumes that the dgrid package is located
         on the filesystem as a sibling to the dojo package -->
    <script src="../dojo/dojo.js"
            data-dojo-config="async: true"></script>

</head>
<body>

<script>
    var store=null;
    var count=1;

    /** JDG server, we don't need this when the Javascript code is downloaded from the JDG server directly,
     * as the host name and port of the URL will be the same */
    var URL="http://localhost:8080";
    var GET="GET";       // GET/key --> value
    var PUT="PUT";       // PUT/key/value --> status message
    var REMOVE="REMOVE"; // REMOVE/key
    var REQUEST_TIMEOUT=5000;

    function display(keyname, valname) {
        var key=document.getElementById(keyname).value;
        var value=document.getElementById(valname).value;
        localPut(key, value);
        put(key, value);
    }

    function localPut(key, value) {
        var element=store.get(key);
        if(element == null) {
            store.add({key: key, value: value}, {overwrite: true});
        }
        else {
            element.value=value;
            store.put(element, {overwrite: true});
        }
    }

    /** Removes the selected key from the grid (no-op if nothing is selected) */
    function localRemove() {
        var key=document.getElementById('key');
        if(key != null && key.value != null)
            store.remove(key.value);
        remove(key.value);
    }

    /** Fetches all values for the keys in the local store from the JDG server and updates the local cache if needed */
    function refreshLocalCache() {
        require(["dojo/_base/array"], function(arrayUtil) {
            var contents=store.query(); // get all objects in the local cache
            arrayUtil.forEach(contents, function(item,index) {
                get(item.key);
            })
        });
    }

    /** Fetches value for key from the JDG grid */
    function get(key) {
        sendRequest(GET + "/" + key, null, function(text) {localPut(key, text);}, 1000);
    }

    /** Sets key/value in the JDG grid */
    function put(key, value) {
        sendRequest(PUT + "/" + key + "/" + value, "Set " + key + "=" + value, null, 1000);
    }

    /** Remove key in the JDG grid */
    function remove(key) {
        sendRequest(REMOVE + "/" + key, "Removed " + key, null, 1000);
    }

    function sendRequest(url, msg, success_function, timeout) {
        require(["dojo/request"], function(request) {
            timeout=timeout || REQUEST_TIMEOUT;
            request(url, {timeout: timeout}).then(
                    success_function? success_function : function(text) {message(msg)},
                    function(error) { // error
                        warning(error.name + ": " + error.message);
                    });
        });
    }

    function message(msg, timeout) {
        setField("status", msg, timeout);
    }

    function warning(msg, timeout) {
        setField("warning", msg, timeout);
    }

    function setField(field_name, msg, timeout) {
        timeout=timeout || 5000;
        var element=document.getElementById(field_name);
        element.innerHTML=msg;
        setTimeout(function() {element.innerHTML="";}, timeout);
    }



</script>


<script>

    require(["dojo/_base/declare", "dojo/store/Memory", "dojo/store/Observable", "dgrid/Grid", "dgrid/Selection",
                "dgrid/Keyboard", "dgrid/OnDemandGrid", "dojo/domReady!"],
            function(declare, Memory, Observable, Grid, Selection, Keyboard, OnDemandGrid) {

                var cache=[
                    {key: "Bela",      value: "Ban"},
                    {key: "Michelle",  value: "Ban"},
                    {key: "Nicole",    value: "Ban"},
                    {key: "Jeannette", value: "Ban"},
                    {key: "Marco",     value: "Furini"}
                ]

                store=new Memory({data:cache, idProperty: "key"});
                store=new Observable(store);

                var grid=new (declare([OnDemandGrid, Selection]))(
                        {store: store,
                            columns: {
                                key: "Key",
                                value: "Value"
                            },
                            selectionMode: "single"
                        }, "grid");

                grid.on("dgrid-select", function(event) {
                    var key=event.rows[0].data.key;
                    var value=event.rows[0].data.value;
                    document.getElementById('key').value=key;
                    document.getElementById('value').value=value;
                });

                grid.on(".dgrid-row:click", function(event){
                    var row = grid.row(event);
                    document.getElementById('key').value=row.data.key;
                    document.getElementById('value').value=row.data.value;
                });

                for(i=0; i < cache.length; i++) {
                    var obj=cache[i];
                    if(obj != null && obj.key != null && obj.value != null)
                        put(obj.key, obj.value);
                }

                setInterval('refreshLocalCache()', 5000);

            });
</script>



<div id="grid"></div>
<p/>
<div id="status" style="color:blue"></div>
<div id="warning" style="color:red"></div>
<p/>
<form id="add" onsubmit="display('key', 'value'); return false;" action="javascript:void(0);">
    <label for='key'>Key: </label>
    <input id='key' name="Key" autofocus/>
    <label for='value'>Value:</label>
    <input id='value' name="Value"/>
    <input type='submit' name="add" value="Put"/>
    <button id="remove-button" type="button" onclick="localRemove()">Remove</button>
    <button id="refresh"       type="button" onclick="refreshLocalCache()">Refresh local cache</button>
</form>

</body>
</html>
